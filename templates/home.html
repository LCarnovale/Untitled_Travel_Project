{% extends "base.html" %}
{% block head %}
	<title>Untitled Travels</title>

	<!-- Script for dateRangePicker -->
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
	<meta charset="utf-8">
	<!-- <link rel="stylesheet" href="/resources/demos/style.css"> -->
	<script type="text/javascript" src="https://cdn.jsdelivr.net/jquery/latest/jquery.min.js"></script>
	<script type="text/javascript" src="https://cdn.jsdelivr.net/momentjs/latest/moment.min.js"></script>
	<script type="text/javascript" src="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.min.js"></script>
	<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.css" />

	<script>
		document.addEventListener('DOMContentLoaded', function () {
			var elems = document.querySelectorAll('.collapsible');
			var instances = M.Collapsible.init(elems, options);
			updateRadius(2500);
		});
	</script>

	<style>
	#map {
		height: 50vw;
		width:  50vw;
		margin-left: auto;
		margin-right: auto;
      }
    #searchkeyword {
    	height: 30px;
    	width: 200px;
    }
</style>
{% endblock %}

{% block content %}
<form method='POST'>
	<div class="container">
		<div class="row">
			<div class="col s12">
				<div class="input-field col s10">
				<input type="text" id="searchgeocode" name="search" oninput="changeSearch(this.value)">
				<label for="searchgeocode" id="searchlabel">Search for Accomodation</label>
				</div><div class="col s2">
					<br>
				<button type="submit" class="btn" id="searchBtn" disabled>Search</button>
				</div>
			</div>
		</div>
		<input type = "hidden" name = "geocodedvalue" id = "geocodedvalue" readonly>
		<input type="text" name="radiusval" id="radiusval" hidden>

		<div class="col s12">
			<p class="range-field">
				<input type="range" id="radiuschange" min="100" max="5000" start="2500" onchange="updateRadius(this.value)" oninput="changeCircle(this.value)"/>
			</p>
		</div>
		<div class="center-align">
			Distance Radius: <output name="radiusrange" id="radiusrange">--</output> m
		<!-- </div> -->
		<ul class="collapsible">
			<li>
				<div class="collapsible-header"><i class="material-icons">add</i>Advanced Search</div>
				<div class="collapsible-body">
					<div class="row">
						<div class="input-field">
							<input type="text" id="keywordinput" name="keyword">
							<label for="keywordinput">Keyword search</label>
						</div>
					</div>
					<div class="row" id="advancesearch">
						<input type="text" id="dates" name="dates" placeholder="Date Range..">
						<div>
							<div class="col s8">
								<p>Beds:</p>
							</div>
							<div class="col s4">
								<input type="number" name="beds" max="99" min="1" value="1" step="1">
							</div>
							<div class="col s8">
								<p>Bathrooms:</p>
							</div>
							<div class="col s4">
								<input type="number" name="beds" max="99" min="1" value="1" step="1">
							</div>
							<div class="col s8">
								<p>Parking Spaces:</p>
							</div>
							<div class="col s4">
								<input type="number" name="beds" max="99" min="1" value="1" step="1">
							</div>
						</div>
					</div>
					
				</div>
			</li>
		</ul>

			<br>
			<div class="col s12">
				<div id="map" class="center-align"></div>
			</div>
		</form>
	</div>
</form>
	
    <script>

		var map;
		var markerlist = [];
		var circlelist = [];
		var geocoder;
		function initMap() {
			map = new google.maps.Map(document.getElementById('map'), {
			  center: {lat: -33.91538902145825 , lng: 151.11207767686824},
			  zoom: 13
			});
			geocoder = new google.maps.Geocoder;
			google.maps.event.addListener(map, 'click', function( event ){
				document.getElementById("geocodedvalue").value = event.latLng.lat()+", "+event.latLng.lng();
				
				for (i = 0;i<markerlist.length;i++){
					markerlist[i].setMap(null);
					circlelist[i].setMap(null);
				}
				var marker = new google.maps.Marker({position: event.latLng, map: map});
				markerlist.push(marker)
				var circle = new google.maps.Circle({map: map, radius: parseInt(document.getElementById("radiusrange").value), fillColor: '#AA0000'});
				circle.bindTo('center', marker, 'position');
				circlelist.push(circle)
				geocoder.geocode({'location': event.latLng}, function(results, status) {
						if (status === 'OK') {
							if (results[0]) {
								var searchBox = document.getElementById('searchgeocode');
								searchBox.value = results[0].formatted_address;
								document.getElementById("searchBtn").disabled = false; // enable search button
								M.updateTextFields(); // Raise the label in the search box

							} 
							else {
								alert('No results found');
							}
						} 
						else {
							alert('Geocoder failed due to: ' + status);
						}
					});
			});
			
		}
		function updateRadius(newval) {
			document.getElementById("radiusval").value = newval;
		// 	if (document.getElementById("searchgeocode").value != '') {
		// 		document.getElementById("searchBtn").disabled = false;
		// 	}
		}

		function changeSearch(newval) {
			if (newval == '') {
				document.getElementById("searchBtn").disabled = true;
			} else {
				// if (document.getElementById("radiusval").value != null) {
					document.getElementById("searchBtn").disabled = false;
				// } else {
				// 	document.getElementById("searchBtn").disabled = true;
				// }
			}
		}

		var distancevalues = [500,1000,1500,2000,3000,4000,5000];
		function changeCircle(newval){
			document.getElementById("radiusrange").value = newval//distancevalues[newval];
			for (i = 0;i<circlelist.length;i++){
				if(circlelist[i]==null)
					continue;
				circlelist[i].setRadius(parseInt(newval));
			}
		}
		var typingTimer;                //timer identifier
		var doneTypingInterval = 1000;  //time in ms
		function getgeocode(){
			
			geocoder.geocode({
				'address': document.getElementById("searchgeocode").value,
				'componentRestrictions': {
					'country': 'AU'
				}
			}, function(results, status) {
						if (status === 'OK') {
							if (results[0] && results[0].geometry &&
								results[0].geometry.bounds) {
								for (i = 0;i<markerlist.length;i++){
									markerlist[i].setMap(null);
									circlelist[i].setMap(null);
								}
								document.getElementById("geocodedvalue").value = results[0].geometry.location.lat()+", "+results[0].geometry.location.lng();
								var marker = new google.maps.Marker({position: results[0].geometry.location, map: map});
								map.setCenter(results[0].geometry.location);
								markerlist.push(marker);
								console.log(document.getElementById('geocodedvalue').value);
								console.log(results[0].geometry.location);
								var radius = Math.round(google.maps.geometry.spherical.computeDistanceBetween(results[0].geometry.location,results[0].geometry.bounds.getSouthWest()));
								
								var maxdiff= 9999;
								var currindex = 0;
								for(i = 0; i<distancevalues.length;i++){
									if (Math.abs(distancevalues[i]-radius) < maxdiff){
										maxdiff = Math.abs(distancevalues[i]-radius)
										currindex = i
									}
								}
								document.getElementById("radiuschange").value = currindex;
								document.getElementById("radiusrange").value = distancevalues[currindex];
								var circle = new google.maps.Circle({map: map, radius: distancevalues[currindex], fillColor: '#AA0000'});
								circle.bindTo('center', marker, 'position');
								circlelist.push(circle);
								console.log('Result: ' + results);
							} else {
								console.log('No results found');
							}
						} else {
							console.log('Geocoder failed due to: ' + status);
						}
					});
		}
		document.getElementById('searchgeocode').addEventListener('keyup', () => {
			clearTimeout(typingTimer);
			if (document.getElementById('searchgeocode').value) {
			typingTimer = setTimeout(getgeocode, doneTypingInterval);
    }
});
	</script>
<script>
	$(function() {
		$('#dates').daterangepicker({
			autoUpdateInput: false,
			minDate: new Date(),
			endDate: moment().add(60, 'days'),
        	locale: {
            	cancelLabel: 'Clear',
            	format: 'DD/MM/YYYY'
        	}
		});
	});
	$('#dates').on('apply.daterangepicker', function(ev, picker) {
      $(this).val(picker.startDate.format('DD/MM/YYYY') + ' - ' + picker.endDate.format('DD/MM/YYYY'));
  	});
	$('#dates').on('cancel.daterangepicker', function(ev, picker) {
        $(this).val('');
    });
    $('#dates').on('apply.daterangepicker', function(ev, picker) {
    	$(this).val(picker.startDate.format('DD/MM/YYYY') + ' - ' + picker.endDate.format('DD/MM/YYYY'));
	});
	$(document).ready(function () {
		$('.collapsible').collapsible();
	});
</script>
	<!-- Actual link: -->	
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDwnoTrb4bDrnE2qSu7q1HiS0pWCsCJS7g&libraries=geometry&callback=initMap" async defer></script>
	<!-- Use a wrong link when map isn't needed: -->		
<!--     <script src="https://maps.googleapis.com/maps/api/js?key=NotARealKey&callback=initMap"></script> -->

{% endblock %}
