{% extends "base.html" %}
{% block head %}

	<title>Post Accommodation</title>

	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<link rel="stylesheet" href="//code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
	<link rel="stylesheet" href="/resources/demos/style.css">
	<script src="https://code.jquery.com/jquery-1.12.4.js"></script>
	<script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>


	<!-- For new date range picker -->
	<script type="text/javascript" src="https://cdn.jsdelivr.net/jquery/latest/jquery.min.js"></script>
	<script type="text/javascript" src="https://cdn.jsdelivr.net/momentjs/latest/moment.min.js"></script>
	<script type="text/javascript" src="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.min.js"></script>
	<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.css" />
	<script type =text/javascript src = "{{ url_for('static',filename = 'new_ad.js')}}"></script>
	<style>#map {
        height: 400px;
		width: 400px;
		margin-left: auto;
		margin-right: auto;
	}
	</style>
	<style>
		table {
			width: 100%;
			font: 17px Calibri;
		}

		table,
		th,
		td {
			border: solid 1px #DDD;
			border-collapse: collapse;
			padding: 2px 3px;
			text-align: center;
		}
	</style>


{% endblock %}

{% block content %}
	<body onload="createTable()">
	<link rel="stylesheet" href = "{{url_for('static',filename = 'formstep.css')}}">

	<h2> Please enter the details of your accommodation: </h2>
	<form name='post_ad' id = "regForm" method='POST' formaction='submit()' enctype="multipart/form-data">
		<div class = "tab">Place Details
			<p><input name = "acc_name" placeholder = "Name" class = "required"></p>
			<p><input name = "acc_nbed" placeholder = "Beds" class = "required" type = number></p>
			<p><input name = "acc_nbath" placeholder = "Bathrooms" class = "required" type = number></p>
			<p><input name = "acc_ncar" placeholder = "Car spaces" class = "required" type = number></p>
			<p><input name = "acc_details" placeholder = "Accommodation description" type = text></p>		
		</div>
		<div class = "tab">Place Details
			<ul id = "imagelist">
			<li><input name = "acc_image-0" id="file-input" type="file" accept="image/*">
			</li>
			</ul>
			<input type="button" id="addImageButton" value="Add Image" onclick = "addImage()"/>
			<div id="preview"></div>
		</div>
		<div class = "tab">Location Details
			<p><input name = "acc_addr" placeholder = "Address" class = "required" id = "hiddenaddress" readonly></p>
			<p><input name = "acc_location" id = "hiddenlocation" class = "required" type = "hidden"></p>
			<div id="map"></div>
		</div>
		{%if 'username' not in session%}
		<div class = "tab">Owner Details
			<p><input name = "own_name" placeholder = "Name" class = "required"></p>
			<p><input name = "own_email" placeholder = "Email" type = "email" class = "required"></p>
			<p><input name = "own_phone" placeholder = "Mobile" class = "required"></p>
			<p><input name = "description" placeholder = "Owner details"></p>
		</div>
		{%else%}
			<p><input name = "own_name" placeholder = "Name" class = "required" type=hidden value = '{{session["username"]}}'></p>
			<p><input name = "own_email" placeholder = "Email" class = "required" type=hidden value = '{{session["email"]}}'></p>
			<p><input name = "own_phone" placeholder = "Mobile" class = "required" type=hidden value = '{{session["mobile"]}}'></p>
			<p><input name = "own_details" placeholder = "Owner details" type = "hidden"></p>
		{%endif%}
		<div class = "tab">Availability Details

			<p><input name = "price" placeholder = "Price" class = "required" type = number step = 0.01></p>

			<p>
				<input id="dateCountOut" name=dateCount type=hidden value=0 method='POST'>

				<div id="t_cont">
					<!-- The table will be put here by the js below -->
					Available Date Ranges:
				</div>

			<input type="button" id="addRangeButton" value="Add Range" onclick="addRange()"/>
			</p>

			<p><input name = "min_stay" placeholder = "Minimum Stay" type = number></p>
			<p><input name = "max_stay" placeholder = "Maximum Stay" type = number></p>
			<p><input name = "details" placeholder = "Additional Details (Noise policy, etc.)"></p>
		</div>
		
		<div style="overflow:auto;">
			<div style="float:right;">
				<button type="button" id="prevBtn" onclick="nextPrev(-1)">Previous</button>
				<button type="button" id="nextBtn" onclick="nextPrev(1)">Next</button>
			</div>
		</div>
		<div style="text-align:center;margin-top:40px;">
			<span class="step"></span>
			<span class="step"></span>
			<span class="step"></span>
			<span class="step"></span>
			{%if 'username' not in session%}
			<span class="step"></span>
			{%endif%}
		</div>
	</form>

	<!-------------------------- Scripts \/ /\ HTML --------------------------------->
	
	<script type="text/javascript">
		var map;
		var markerlist = [];
		var geocoder;
		function initMap() {
			map = new google.maps.Map(
				document.getElementById('map'), {
					center: {lat: -33.91538902145825 , lng: 151.11207767686824},
					zoom: 13
				}
			);
			geocoder = new google.maps.Geocoder;
			google.maps.event.addListener(
				map, 'click', function( event ) {
					document.getElementById("hiddenlocation").value = event.latLng.lat() + ", " + event.latLng.lng();
					document.getElementById("hiddenlocation").value =
						event.latLng.lat() + ", " + event.latLng.lng();
					for (i = 0;i<markerlist.length;i++){
						markerlist[i].setMap(null);
					}
					markerlist.length = 0;
					var marker = new google.maps.Marker({position: event.latLng, map: map});
					markerlist.push(marker);
					geocoder.geocode({'location': event.latLng}, function(results, status) {
						if (status === 'OK') {
							if (results[0]) {
								document.getElementById("hiddenaddress").value = results[0].formatted_address;
							} 
							else {
								alert('No results found');
							}
						} 
						else {
							alert('Geocoder failed due to: ' + status);
						}
					});
				}
			);
		}


			//function submit() {
		 	//window.prompt("prompt");
		 	//console.log("Submitting");
			//}
	var imagelen = 0;
	function addImage() {
		var imagetemp = document.getElementsByName('acc_image-'+imagelen)
		
		for(i=0;i<imagetemp.length;i++){
			if(imagetemp[i].tagName == 'INPUT'){
				console.log(imagetemp[i].value)
				if(imagetemp[i].value == ""){
					return false
				}
			}
		}
		imagelen+=1;
		var node = document.createElement("LI");
		node.setAttribute('name', 'acc_image-'+imagelen);
		var input = document.createElement("input");
		input.setAttribute('type', 'file');
		input.setAttribute('name', 'acc_image-'+imagelen);
		input.setAttribute('accept','image/*');
		input.addEventListener("change", previewImage);
		var removeButton = document.createElement('input');
		removeButton.setAttribute('type', 'button');
		removeButton.setAttribute('value', 'Remove');
		removeButton.setAttribute('onclick', 'removeImage(this)');
		removeButton.setAttribute('name', 'acc_image-'+imagelen);
		node.appendChild(input)
		node.appendChild(removeButton)
		var list = document.getElementById('imagelist')
		list.appendChild(node)
	}
	function removeImage(buttonObj){
		var imagenode = document.getElementsByName(buttonObj.name)
		console.log(buttonObj.name)
		while(imagenode.length > 0){
			imagenode[0].remove()
		}
		imagelen--
	}
	function previewImage() { 
		var preview = document.querySelector('#preview');
		if (this.files) {
			[].forEach.call(this.files, readAndPreview);
		}

		function readAndPreview(file) {

			var reader = new FileReader();

			reader.addEventListener("load", function() {
			  var node = document.createElement("LI")
			  node.setAttribute('name', 'acc_image-'+imagelen)
			  var image = new Image();
			  image.height = 100;
			  image.title  = file.name;
			  image.src    = this.result;
			  node.appendChild(image);
			  node.append(document.createElement("br"));
			  node.append(document.createElement("br"));
			  preview.appendChild(node);
			});
			reader.readAsDataURL(file);
		}
	}
	document.querySelector('#file-input').addEventListener("change", previewImage);
	</script>
	<!-- Actual link: -->
	<!--script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDwnoTrb4bDrnE2qSu7q1HiS0pWCsCJS7g&callback=initMap"async defer></script> -->
	<!-- Use a wrong link when map isn't needed: -->
	 <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyD4bDrnE2qSu7q1HiS0pWCsCJS7g&callback=initMap"></script>
	<script type =text/javascript src = "{{ url_for('static',filename = 'formstep.js')}}"></script>


{% endblock %}
